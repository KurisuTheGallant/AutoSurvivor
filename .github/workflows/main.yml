name: Build AutoSurvivor

on:
  push:
    branches: [ "main" ]

env:
  UNREAL_ENGINE_PATH: "D:\\UE_5.7"
  PROJECT_NAME: "AutoSurvivor"
  # Ensure this path exists on your E: drive
  TARGET_COPY_PATH: "E:\\MyFinishedGames"

jobs:
  build-windows:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        
      - name: Setup Environment
        run: |
          echo "Building ${{ env.PROJECT_NAME }}..."
          
      # Step 1: Build the EDITOR (Needed to cook assets)
      - name: Build Editor
        shell: cmd
        run: |
          "%UNREAL_ENGINE_PATH%\\Engine\\Build\\BatchFiles\\Build.bat" ${{ env.PROJECT_NAME }}Editor Win64 Development -Project="%CD%\\${{ env.PROJECT_NAME }}.uproject" -WaitMutex

      # Step 2: Build the GAME (Needed to run the .exe) - THIS WAS MISSING
      - name: Build Game
        shell: cmd
        run: |
          "%UNREAL_ENGINE_PATH%\\Engine\\Build\\BatchFiles\\Build.bat" ${{ env.PROJECT_NAME }} Win64 Development -Project="%CD%\\${{ env.PROJECT_NAME }}.uproject" -WaitMutex

      # Step 3: Cook and Package
      - name: Cook and Package
        shell: cmd
        run: |
          "%UNREAL_ENGINE_PATH%\\Engine\\Build\\BatchFiles\\RunUAT.bat" BuildCookRun -project="%CD%\\${{ env.PROJECT_NAME }}.uproject" -noP4 -platform=Win64 -clientconfig=Development -serverconfig=Development -cook -allmaps -build -stage -pak -archive -archivedirectory="%CD%\\Packaged"

      - name: Copy to Local Folder
        shell: cmd
        run: |
          mkdir "%TARGET_COPY_PATH%\\LatestBuild" 2>NUL
          xcopy "%CD%\\Packaged\\Windows" "%TARGET_COPY_PATH%\\LatestBuild" /E /I /Y
          echo "Game copied to %TARGET_COPY_PATH%\\LatestBuild"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: Packaged/